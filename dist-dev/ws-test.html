<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DegenDuel WebSocket Test</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", Arial, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      color: #333;
      line-height: 1.5;
    }
    h1 { 
      color: #4a6ee0;
      border-bottom: 2px solid #4a6ee0;
      padding-bottom: 10px;
      margin-bottom: 30px;
    }
    h2 {
      color: #4a6ee0;
      margin-top: 30px;
    }
    .form-group {
      margin-bottom: 15px;
    }
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }
    select, input[type="text"], textarea {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      box-sizing: border-box;
      font-family: inherit;
      font-size: 14px;
    }
    button {
      background-color: #4a6ee0;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      margin-right: 10px;
    }
    button:hover {
      background-color: #3a5ec0;
    }
    button.danger {
      background-color: #e04a4a;
    }
    button.danger:hover {
      background-color: #c03a3a;
    }
    button.success {
      background-color: #4ae04a;
    }
    button.success:hover {
      background-color: #3ac03a;
    }
    button:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
    }
    #status {
      margin: 20px 0;
      padding: 10px;
      background-color: #f9f9f9;
      border-left: 4px solid #4a6ee0;
    }
    #log {
      background-color: #f9f9f9;
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 10px;
      height: 400px;
      overflow-y: scroll;
      font-family: monospace;
      font-size: 14px;
    }
    .log-entry {
      margin-bottom: 5px;
      border-bottom: 1px solid #eee;
      padding-bottom: 5px;
    }
    .log-time {
      color: #999;
      margin-right: 10px;
    }
    .log-info {
      color: #4a6ee0;
    }
    .log-error {
      color: #e04a4a;
    }
    .log-success {
      color: #4ae04a;
    }
    .log-warning {
      color: #e0e04a;
    }
    .log-message {
      color: #333;
    }
    .code {
      font-family: monospace;
      background-color: #f5f5f5;
      padding: 2px 4px;
      border-radius: 3px;
      font-size: 90%;
    }
    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }
    @media (max-width: 768px) {
      .grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <h1>DegenDuel WebSocket Tester</h1>
  
  <div id="status">
    Status: <span id="connection-status">Disconnected</span>
  </div>
  
  <div class="grid">
    <div>
      <h2>Connection Settings</h2>
      
      <div class="form-group">
        <label for="endpoint">WebSocket Endpoint:</label>
        <select id="endpoint">
          <option value="/api/v69/ws/monitor">Monitor WebSocket (v69)</option>
          <option value="/api/v69/ws/token-data">Token Data WebSocket (v69)</option>
          <option value="/api/v69/ws/skyduel">SkyDuel WebSocket (v69)</option>
          <option value="/api/v69/ws/circuit-breaker">Circuit Breaker WebSocket (v69)</option>
          <option value="/api/v69/ws/system-settings">System Settings WebSocket (v69)</option>
        </select>
      </div>
      
      <div class="form-group">
        <label for="token">Authentication Token:</label>
        <input type="text" id="token" placeholder="Paste your auth token here or leave blank for public endpoints">
      </div>
      
      <div class="form-group">
        <label for="token-source">Token Source:</label>
        <select id="token-source">
          <option value="query">Query Parameter (most compatible)</option>
          <option value="protocol">WebSocket Protocol</option>
          <option value="auto">Automatic</option>
        </select>
      </div>
      
      <div class="form-group">
        <label for="host">Server:</label>
        <input type="text" id="host" value="localhost:3004">
      </div>
      
      <div class="form-group">
        <label for="protocol">Protocol:</label>
        <select id="protocol">
          <option value="ws">ws (Normal)</option>
          <option value="wss">wss (Secure)</option>
        </select>
      </div>
      
      <div>
        <button id="connect">Connect</button>
        <button id="disconnect" disabled>Disconnect</button>
        <button id="generate-url" class="success">Generate URL</button>
      </div>

      <div class="form-group" style="margin-top: 20px;">
        <label for="generated-url">Generated WebSocket URL:</label>
        <input type="text" id="generated-url" readonly>
      </div>
      
      <h2>Send Message</h2>
      
      <div class="form-group">
        <label for="message-type">Message Type:</label>
        <select id="message-type">
          <option value="heartbeat">Heartbeat</option>
          <option value="get_metrics">Get Metrics</option>
          <option value="get_status">Get Status</option>
          <option value="get_tokens">Get Tokens</option>
          <option value="get_service_status">Get Service Status</option>
          <option value="subscribe">Subscribe to Channel</option>
          <option value="unsubscribe">Unsubscribe from Channel</option>
          <option value="custom">Custom Message</option>
        </select>
      </div>
      
      <div class="form-group" id="channel-group" style="display:none">
        <label for="channel">Channel:</label>
        <input type="text" id="channel" placeholder="Channel name (e.g., system.status)">
      </div>
      
      <div class="form-group" id="custom-message-group" style="display:none">
        <label for="custom-message">Custom Message JSON:</label>
        <textarea id="custom-message" rows="5" placeholder='{"type":"custom","data":{}}' style="font-family: monospace;"></textarea>
      </div>
      
      <button id="send" disabled>Send Message</button>
      <button id="clear-log" class="danger">Clear Log</button>
    </div>
    
    <div>
      <h2>WebSocket Log</h2>
      <div id="log"></div>
    </div>
  </div>

  <script>
    // DOM Elements
    const connectBtn = document.getElementById('connect');
    const disconnectBtn = document.getElementById('disconnect');
    const sendBtn = document.getElementById('send');
    const clearLogBtn = document.getElementById('clear-log');
    const statusSpan = document.getElementById('connection-status');
    const logDiv = document.getElementById('log');
    const messageTypeSelect = document.getElementById('message-type');
    const channelGroup = document.getElementById('channel-group');
    const customMessageGroup = document.getElementById('custom-message-group');
    const generateUrlBtn = document.getElementById('generate-url');
    const generatedUrlInput = document.getElementById('generated-url');
    
    // WebSocket state
    let socket = null;
    let isConnected = false;
    
    // Event Listeners
    connectBtn.addEventListener('click', connect);
    disconnectBtn.addEventListener('click', disconnect);
    sendBtn.addEventListener('click', sendMessage);
    clearLogBtn.addEventListener('click', clearLog);
    generateUrlBtn.addEventListener('click', generateUrl);
    messageTypeSelect.addEventListener('change', updateMessageInputs);
    
    // Show/hide message inputs based on message type
    function updateMessageInputs() {
      const messageType = messageTypeSelect.value;
      
      if (messageType === 'subscribe' || messageType === 'unsubscribe') {
        channelGroup.style.display = 'block';
        customMessageGroup.style.display = 'none';
      } else if (messageType === 'custom') {
        channelGroup.style.display = 'none';
        customMessageGroup.style.display = 'block';
      } else {
        channelGroup.style.display = 'none';
        customMessageGroup.style.display = 'none';
      }
    }
    
    // Generate WebSocket URL
    function generateUrl() {
      const protocol = document.getElementById('protocol').value;
      const host = document.getElementById('host').value;
      const endpoint = document.getElementById('endpoint').value;
      const token = document.getElementById('token').value;
      const tokenSource = document.getElementById('token-source').value;
      
      let url = `${protocol}://${host}${endpoint}`;
      
      // Add token as query parameter if specified
      if (token && tokenSource === 'query') {
        url += `?token=${encodeURIComponent(token)}`;
      }
      
      generatedUrlInput.value = url;
      return url;
    }
    
    // Connect to WebSocket
    function connect() {
      if (isConnected) {
        logMessage('Already connected', 'warning');
        return;
      }
      
      try {
        // Generate the URL
        const wsUrl = generateUrl();
        const token = document.getElementById('token').value;
        const tokenSource = document.getElementById('token-source').value;
        
        logMessage(`Connecting to ${wsUrl}`, 'info');
        
        // Create WebSocket with protocol token if specified
        if (token && tokenSource === 'protocol') {
          socket = new WebSocket(wsUrl, [token]);
          logMessage('Using token as WebSocket protocol', 'info');
        } else {
          socket = new WebSocket(wsUrl);
        }
        
        // Set up event handlers
        socket.onopen = handleOpen;
        socket.onmessage = handleMessage;
        socket.onclose = handleClose;
        socket.onerror = handleError;
        
        // Update UI
        connectBtn.disabled = true;
        disconnectBtn.disabled = false;
        statusSpan.textContent = 'Connecting...';
        
      } catch (error) {
        logMessage(`Connection error: ${error.message}`, 'error');
      }
    }
    
    // Disconnect from WebSocket
    function disconnect() {
      if (!isConnected) {
        logMessage('Not connected', 'warning');
        return;
      }
      
      try {
        socket.close(1000, 'User-initiated disconnect');
        logMessage('Disconnecting...', 'info');
      } catch (error) {
        logMessage(`Disconnect error: ${error.message}`, 'error');
      }
    }
    
    // Handle WebSocket open event
    function handleOpen(event) {
      isConnected = true;
      statusSpan.textContent = 'Connected';
      statusSpan.style.color = 'green';
      sendBtn.disabled = false;
      
      logMessage('Connection established', 'success');
    }
    
    // Handle WebSocket message event
    function handleMessage(event) {
      try {
        const data = JSON.parse(event.data);
        logMessage(`Received: ${JSON.stringify(data, null, 2)}`, 'info');
      } catch (error) {
        logMessage(`Received: ${event.data}`, 'info');
        logMessage(`Parse error: ${error.message}`, 'error');
      }
    }
    
    // Handle WebSocket close event
    function handleClose(event) {
      isConnected = false;
      statusSpan.textContent = `Disconnected (Code: ${event.code})`;
      statusSpan.style.color = 'red';
      connectBtn.disabled = false;
      disconnectBtn.disabled = true;
      sendBtn.disabled = true;
      
      if (event.wasClean) {
        logMessage(`Connection closed cleanly, code=${event.code}, reason=${event.reason}`, 'info');
      } else {
        logMessage(`Connection died, code=${event.code}`, 'error');
      }
    }
    
    // Handle WebSocket error event
    function handleError(event) {
      logMessage('WebSocket error', 'error');
      console.error('WebSocket error:', event);
    }
    
    // Send message to WebSocket
    function sendMessage() {
      if (!isConnected) {
        logMessage('Not connected', 'warning');
        return;
      }
      
      try {
        const messageType = messageTypeSelect.value;
        let message;
        
        // Create message based on type
        if (messageType === 'custom') {
          const customMessage = document.getElementById('custom-message').value;
          message = JSON.parse(customMessage);
        } else if (messageType === 'subscribe') {
          const channel = document.getElementById('channel').value;
          message = {
            type: 'subscribe',
            channel: channel,
            timestamp: new Date().toISOString()
          };
        } else if (messageType === 'unsubscribe') {
          const channel = document.getElementById('channel').value;
          message = {
            type: 'unsubscribe',
            channel: channel,
            timestamp: new Date().toISOString()
          };
        } else if (messageType === 'heartbeat') {
          message = {
            type: 'heartbeat',
            timestamp: new Date().toISOString()
          };
        } else if (messageType === 'get_metrics') {
          message = {
            type: 'get_metrics',
            timestamp: new Date().toISOString()
          };
        } else if (messageType === 'get_status') {
          message = {
            type: 'get_status',
            timestamp: new Date().toISOString()
          };
        } else if (messageType === 'get_tokens') {
          message = {
            type: 'get_tokens',
            limit: 10,
            timestamp: new Date().toISOString()
          };
        } else if (messageType === 'get_service_status') {
          message = {
            type: 'get_service_status',
            service: 'all',
            timestamp: new Date().toISOString()
          };
        }
        
        // Send the message
        socket.send(JSON.stringify(message));
        logMessage(`Sent: ${JSON.stringify(message, null, 2)}`, 'success');
        
      } catch (error) {
        logMessage(`Send error: ${error.message}`, 'error');
      }
    }
    
    // Log message to UI
    function logMessage(message, type = 'info') {
      const logEntry = document.createElement('div');
      logEntry.className = 'log-entry';
      
      const time = new Date().toLocaleTimeString();
      const logTime = document.createElement('span');
      logTime.className = 'log-time';
      logTime.textContent = time;
      
      const logType = document.createElement('span');
      logType.className = `log-${type}`;
      logType.textContent = type.toUpperCase() + ': ';
      
      const logMessage = document.createElement('span');
      logMessage.className = 'log-message';
      
      // Format JSON nicely with line breaks
      if (message.includes('{') && message.includes('}')) {
        const pre = document.createElement('pre');
        pre.textContent = message;
        logMessage.appendChild(pre);
      } else {
        logMessage.textContent = message;
      }
      
      logEntry.appendChild(logTime);
      logEntry.appendChild(logType);
      logEntry.appendChild(logMessage);
      
      logDiv.appendChild(logEntry);
      logDiv.scrollTop = logDiv.scrollHeight; // Auto-scroll to bottom
    }
    
    // Clear log
    function clearLog() {
      logDiv.innerHTML = '';
    }
    
    // Initialize inputs
    updateMessageInputs();
    generateUrl();
    
    // Log page load
    logMessage('WebSocket tester ready', 'info');
    logMessage('Tip: Use the browser developer console to debug', 'info');
    logMessage('This tool tests browser WebSocket support, for CLI use wscat or websocat.', 'info');
  </script>
</body>
</html>